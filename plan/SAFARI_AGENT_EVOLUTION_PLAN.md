# VISION SAFARI AGENT EVOLUTION PLAN

## 1) 기획 배경 (왜 이 기획이 나왔는가)

현재 Vision Safari는 플레이어(`P`)와 동물 아이콘이 같은 타일에 겹칠 수 있다. 이 구조는 인간 기준에서는 자연스럽지만, 모델이 10x10 캔버스 이미지를 해석하는 과정에서는 다음 문제가 발생한다.

- 동일 타일에 요소가 중첩되면 시각 정보가 손실되어 동물 식별 정확도가 낮아진다.
- `이동(move)` 자체가 `탐색 + 획득` 역할을 동시에 가져, 행동 의미가 모호해진다.
- 에이전트가 "근접해서 상호작용"하는 전략을 학습하기 어렵고, 단순 이동 반복으로 수렴하기 쉽다.

즉, 이번 기획은 단순 UI 변경이 아니라 **모델 인식 안정화 + 행동 공간 고도화**를 위한 구조 개편이다.

## 2) 문제 정의

### As-Is
- `move`로 동물 타일 진입 가능
- 동물 도달 판단이 `onAnimal`에 의존
- 목표 달성 흐름이 `발견/포획`이 아니라 `이동 결과`에 암묵적으로 결합

### To-Be
- 플레이어는 동물/나무 타일로 진입 불가 (충돌 객체 통합)
- 별도 `catch` 툴로 상/하/좌/우 인접 동물을 포획
- 포획 성공 시 동물은 즉시 맵에서 제거
- 에이전트는 `탐색(move)`과 `상호작용(catch)`를 분리해 더 명시적으로 의사결정

## 3) 제품/에이전트 관점 목표

- 모델 입력 이미지에서 중첩으로 인한 인식 실패 제거
- 툴셋을 통해 "관찰→근접→포획"의 명확한 게임 루프 제공
- 미션 달성 신뢰도 및 행동 설명 가능성(interpretability) 향상

## 4) 수정 방향

1. **게임 규칙 단순화/명시화**
- 이동 불가 객체: 경계, 나무, 동물
- 포획은 이동이 아닌 상호작용 액션으로 분리

2. **툴 인터페이스 확장**
- 신규 툴 `catch(direction)` 추가
- 성공/실패 사유를 구조화된 결과로 반환

3. **프롬프트 재설계**
- "타일 위 도달" 중심 규칙 제거
- "인접 시 catch 우선" 규칙 강화
- 기존 `onAnimal` 언급 제거

4. **동기화/관측 일관성 강화**
- 포획 성공 즉시 서버 상태와 클라이언트 렌더 동기화
- 로그/디버그에 `catch` 근거가 남도록 표준화

## 5) 영향 범위

### 서버 엔진
- `web/server/utils/safari/game-engine.ts`
  - 이동 충돌 규칙 변경
  - 포획 메서드(예: `catchAnimal`) 추가
  - 결과 타입 확장 (`blockedReason`, `catchResult`)

### 에이전트 도구/프롬프트
- `web/server/utils/safari/tools.ts`
  - `catch` tool schema/handler 추가
  - `SYSTEM_PROMPT` 전면 개편 (행동 규칙/워크플로우)
  - `move` 설명 및 기대 결과 수정

### 에이전트 실행 그래프
- `web/server/utils/safari/nodes.ts`
  - 새 툴 결과 처리
  - 툴 실행 로그/디버그 포맷 점검

### WebSocket 라우트
- `web/server/routes/_ws/safari.ts`
  - `catch` 반영 후 상태 브로드캐스트 정책 정리
  - 동물 제거 반영 이벤트 추가(또는 `gameState` 재전송)

### 프론트 UI/상태
- `web/app/composables/safari/useWebSocket.ts`
- `web/app/composables/safari/useGame.ts`
- `web/app/pages/safari/index.vue`
- `web/app/pages/safari/agent-view.vue`
  - 포획 후 동물 제거 렌더링 일관성 확보
  - 필요 시 포획 성공/실패 시각 피드백 추가

### 문서
- `docs/SAFARI_AGENT_DESCRIPTION.md`
  - 도구 정의(4개→5개 또는 기존 대체) 업데이트
  - Core Loop에 `catch` 단계 반영

## 6) 단계별 실행 계획

### Phase 1. 게임 엔진 규칙 개편
- 이동 충돌 대상에 동물 포함
- `catch(direction)` 구현
- 단위 동작 검증: 경계/나무/동물 충돌, 포획 성공/실패

### Phase 2. 툴셋 및 프롬프트 개편
- `catch` tool 등록 및 핸들러 구현
- 프롬프트에서 old rule(`onAnimal`) 제거
- "인접 타겟 발견 시 catch 우선" 규칙 추가

### Phase 3. 런타임 파이프라인/WS 반영
- tool execution path에 `catch` 결과 전파
- 포획 성공 시 동물 상태를 모든 클라이언트에 동기화

### Phase 4. UI 반영 및 관측성 개선
- 메인 맵/에이전트 뷰 즉시 반영
- 로그에 `catch` 액션과 결과(좌표, 대상, 이유) 표준화

### Phase 5. 문서/데이터셋 정합
- 설명 문서 업데이트
- 데이터 수집 포맷에서 `catch` call/result 누락 여부 점검

## 7) 수용 기준 (Acceptance Criteria)

- 플레이어가 동물 타일로 이동 시도 시 이동이 차단된다.
- `catch`는 인접 1칸 방향만 허용한다.
- 인접 칸에 동물이 있으면 포획되고 즉시 맵에서 제거된다.
- 인접 칸에 동물이 없으면 명확한 실패 이유가 반환된다.
- 에이전트 로그/디버그에 `catch` 호출과 결과가 기록된다.
- 프롬프트가 새 규칙을 일관되게 반영한다.

## 8) 리스크 및 대응

- 리스크: 모델이 여전히 `move`만 반복
  - 대응: 프롬프트에 `타겟 인접 시 catch 우선` 강제 규칙 명시

- 리스크: 상태 동기화 지연으로 화면 불일치
  - 대응: 포획 성공 이벤트 직후 `gameState` 또는 delta 강제 브로드캐스트

- 리스크: 기존 `onAnimal` 의존 코드 잔존
  - 대응: 전역 검색 후 제거/대체, 타입 단계에서 컴파일 에러로 차단

## 9) 구현 우선순위

1. 엔진 충돌/포획 API
2. `catch` tool + 프롬프트
3. WS 브로드캐스트
4. 프론트 렌더 동기화
5. 문서/데이터 정리

## 10) 기대 효과

- 이미지 인식 실패의 핵심 원인(중첩) 제거
- 행동 공간이 탐색과 상호작용으로 분리되어 에이전트 전략성 향상
- 디버깅/학습 데이터 품질 향상으로 후속 고도화 비용 감소
